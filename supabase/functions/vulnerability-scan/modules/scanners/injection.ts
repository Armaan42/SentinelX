import { BaseScanner } from './active-base.ts';
import { CrawledUrl, VulnerabilityFinding } from '../../core/types.ts';
import { LFI_PAYLOADS } from '../../core/payloads.ts';

const CMD_INJECTION_PAYLOADS = [
    '; ls',
    '| whoami',
    '& dir',
    '$(whoami)',
    '`whoami`'
];

export class InjectionScanner extends BaseScanner {
    async scan(target: CrawledUrl): Promise<VulnerabilityFinding[]> {
        const findings: VulnerabilityFinding[] = [];

        if (target.params.length > 0) {
            for (const param of target.params) {
                // Path Traversal
                for (const payload of LFI_PAYLOADS) {
                    const url = new URL(target.url);
                    url.searchParams.set(param, payload);
                    try {
                        const { response } = await this.client.get(url.toString());
                        const body = await response.text();
                        if (/(root:|\[extensions\]|\[fonts\]|\[files\])/i.test(body) && body.length < 50000) {
                            findings.push({
                                id: `LFI-${Date.now()}`,
                                title: 'Path Traversal detected',
                                owasp_category: 'A03:2021 - Injection',
                                severity: 'critical',
                                status: 'vulnerable',
                                detection_type: 'lfi',
                                confidence: 90,
                                evidence: [`Payload: ${payload}`, 'Sensitive file content detected'],
                                recommendation: 'Validate user input and use safe file APIs.',
                                references: ['https://owasp.org/Top10/A03_2021-Injection/'],
                                affected_url: target.url,
                                param,
                                payload
                            });
                            break;
                        }
                    } catch (e) { console.warn(`[LFI] Error: ${e}`); }
                }

                // Command Injection
                for (const payload of CMD_INJECTION_PAYLOADS) {
                    const url = new URL(target.url);
                    url.searchParams.set(param, payload);
                    try {
                        const { response } = await this.client.get(url.toString());
                        const body = await response.text();
                        if (/(uid=[0-9]|root|admin|Administrator)/i.test(body)) { // Simple check for whoami/ls output
                            findings.push({
                                id: `CMI-${Date.now()}`,
                                title: 'Command Injection detected',
                                owasp_category: 'A03:2021 - Injection',
                                severity: 'critical',
                                status: 'vulnerable',
                                detection_type: 'rce',
                                confidence: 95,
                                evidence: [`Payload: ${payload}`, 'Command output detected'],
                                recommendation: 'Avoid system calls with user input.',
                                references: ['https://owasp.org/Top10/A03_2021-Injection/'],
                                affected_url: target.url,
                                param,
                                payload
                            });
                            break;
                        }
                    } catch (e) { console.warn(`[CMI] Error: ${e}`); }
                }
            }
        }
        return findings;
    }
}
