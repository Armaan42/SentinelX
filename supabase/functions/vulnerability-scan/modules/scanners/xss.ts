import { BaseScanner } from './active-base.ts';
import { CrawledUrl, VulnerabilityFinding } from '../../core/types.ts';
import { XSS_PAYLOADS } from '../../core/payloads.ts';
import { Analyzer } from '../../core/analyzer.ts';

export class XssScanner extends BaseScanner {
    async scan(target: CrawledUrl): Promise<VulnerabilityFinding[]> {
        const findings: VulnerabilityFinding[] = [];

        // Test URL Parameters
        // Only scan if parameters exist to avoid useless requests
        if (target.params.length > 0) {
            for (const param of target.params) {
                // Limit to top 2 payloads for speed
                for (const payload of XSS_PAYLOADS.slice(0, 2)) {
                    const canary = `xss${Math.random().toString(36).substring(7)}`;
                    const testPayload = payload.replace('alert(1)', `console.log('${canary}')`);

                    const url = new URL(target.url);
                    url.searchParams.set(param, testPayload);

                    try {
                        const { response } = await this.client.get(url.toString());
                        const body = await response.text();

                        // Simple reflection check
                        if (body.includes(testPayload)) {
                            findings.push({
                                id: `XSS-${Date.now()}`,
                                title: 'Reflected Cross-Site Scripting (XSS)',
                                owasp_category: 'A03:2021 - Injection',
                                severity: 'high',
                                status: 'vulnerable',
                                detection_type: 'xss',
                                confidence: 85,
                                evidence: [`Payload reflected in response: ${testPayload}`],
                                recommendation: 'Implement context-aware output encoding.',
                                references: ['https://owasp.org/Top10/A03_2021-Injection/'],
                                affected_url: target.url,
                                param,
                                payload: testPayload
                            });
                            break;
                        }
                    } catch (e) {
                        console.warn(`[XSS] Failed scan for ${param}: ${e}`);
                    }
                }
            }
        }

        return findings;
    }
}
