import { BaseScanner } from './active-base.ts';
import { CrawledUrl, VulnerabilityFinding } from '../../core/types.ts';

export class RedirectScanner extends BaseScanner {
    async scan(target: CrawledUrl): Promise<VulnerabilityFinding[]> {
        const findings: VulnerabilityFinding[] = [];

        if (target.params.length > 0) {
            for (const param of target.params) {
                if (/url|redirect|next|dest|target/i.test(param)) {
                    const payload = 'https://example.com';
                    const url = new URL(target.url);
                    url.searchParams.set(param, payload);

                    try {
                        const { response } = await this.client.fetch(url.toString(), { method: 'GET', redirect: 'manual' });
                        const location = response.headers.get('location');
                        if (location && location.includes('example.com')) {
                            findings.push({
                                id: `OR-${Date.now()}`,
                                title: 'Open Redirect',
                                owasp_category: 'A01:2021 - Broken Access Control',
                                severity: 'medium',
                                status: 'vulnerable',
                                detection_type: 'behavior',
                                confidence: 90,
                                evidence: [`Payload: ${payload}`, `Redirected to: ${location}`],
                                recommendation: 'Validate redirect targets against a whitelist.',
                                references: ['https://owasp.org/Top10/A01_2021-Broken_Access_Control/'],
                                affected_url: target.url,
                                param,
                                payload
                            });
                        }
                    } catch (e) { console.warn(`[Redirect] Error: ${e}`); }
                }
            }
        }
        return findings;
    }
}
