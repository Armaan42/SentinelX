import { BaseScanner } from './active-base.ts';
import { CrawledUrl, VulnerabilityFinding } from '../../core/types.ts';

export class ApiScanner extends BaseScanner {
    async scan(target: CrawledUrl): Promise<VulnerabilityFinding[]> {
        const findings: VulnerabilityFinding[] = [];

        // 1. GraphQL Introspection Check
        if (target.url.includes('/graphql') || target.url.includes('/gql')) {
            const query = `{"query": "{ __schema { types { name } } }"}`;
            try {
                const { response } = await this.client.fetch(target.url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: query
                });
                const body = await response.text();
                if (body.includes('__schema') && body.includes('types')) {
                    findings.push({
                        id: `GQL-INTRO-${Date.now()}`,
                        title: 'GraphQL Introspection Enabled',
                        owasp_category: 'A05:2021 - Security Misconfiguration',
                        severity: 'low',
                        status: 'vulnerable',
                        detection_type: 'misconfiguration',
                        confidence: 100,
                        evidence: ['GraphQL Schema Introspection query returned valid schema'],
                        recommendation: 'Disable introspection in production environments.',
                        references: ['https://cheatsheetseries.owasp.org/cheatsheets/GraphQL_Cheat_Sheet.html'],
                        affected_url: target.url
                    });
                }
            } catch { }
        }

        // 2. REST API Verb Tampering / Unprotected Methods
        // If we find an API endpoint (e.g., returns JSON), try hazardous methods
        if (target.url.includes('/api/')) {
            const hazardousMethods = ['PUT', 'DELETE'];
            for (const method of hazardousMethods) {
                try {
                    const { response } = await this.client.fetch(target.url, { method });
                    // If we get 200 OK or 204 No Content (instead of 401/403/405), it's risky
                    if (response.status === 200 || response.status === 204) {
                        findings.push({
                            id: `API-METHOD-${Date.now()}`,
                            title: `Unprotected ${method} Method`,
                            owasp_category: 'A01:2021 - Broken Access Control',
                            severity: 'medium',
                            status: 'vulnerable',
                            detection_type: 'misconfiguration',
                            confidence: 80,
                            evidence: [`Endpoint accepts ${method} request without authentication/authorization`],
                            recommendation: 'Disable unused HTTP methods and enforce auth.',
                            references: ['https://owasp.org/Top10/A01_2021-Broken_Access_Control/'],
                            affected_url: target.url
                        });
                    }
                } catch { }
            }
        }

        return findings;
    }
}
