import { BaseScanner } from './active-base.ts';
import { CrawledUrl, VulnerabilityFinding } from '../../core/types.ts';

export class HeadersScanner extends BaseScanner {
    async scan(target: CrawledUrl): Promise<VulnerabilityFinding[]> {
        const findings: VulnerabilityFinding[] = [];

        // Only scan headers on the first page visited (depth 0) to save time
        // or if it's the specific target
        if (target.depth > 0) return [];

        try {
            const { response } = await this.client.get(target.url);
            const headers = response.headers;

            // Strict Parity Checks
            if (!headers.has('content-security-policy')) {
                findings.push({
                    id: 'SIG-A04-001',
                    title: 'Missing Content-Security-Policy',
                    owasp_category: 'A04:2021 - Insecure Design',
                    severity: 'high',
                    status: 'vulnerable',
                    detection_type: 'header_missing',
                    confidence: 100,
                    evidence: ['Header missing'],
                    recommendation: 'Implement strict CSP',
                    references: ['https://owasp.org/Top10/A04_2021-Insecure_Design/']
                });
            }

            if (!headers.has('x-frame-options')) {
                findings.push({
                    id: 'SIG-A04-003',
                    title: 'Missing X-Frame-Options',
                    owasp_category: 'A04:2021 - Insecure Design',
                    severity: 'high',
                    status: 'vulnerable',
                    detection_type: 'header_missing',
                    confidence: 100,
                    evidence: ['Header missing'],
                    recommendation: 'Add X-Frame-Options: DENY',
                    references: ['https://owasp.org/Top10/A04_2021-Insecure_Design/']
                });
            }

            if (!headers.has('strict-transport-security') && target.url.startsWith('https')) {
                findings.push({
                    id: 'SIG-A02-001',
                    title: 'Missing Strict-Transport-Security',
                    owasp_category: 'A02:2021 - Cryptographic Failures',
                    severity: 'medium',
                    status: 'vulnerable',
                    detection_type: 'header_missing',
                    confidence: 100,
                    evidence: ['Header missing'],
                    recommendation: 'Add HSTS header',
                    references: ['https://owasp.org/Top10/A02_2021-Cryptographic_Failures/']
                });
            }

            // Information Disclosure
            const server = headers.get('server');
            if (server) {
                findings.push({
                    id: 'SIG-A05-001',
                    title: 'Server Version Disclosure',
                    owasp_category: 'A05:2021 - Security Misconfiguration',
                    severity: 'low',
                    status: 'vulnerable',
                    detection_type: 'header_value',
                    confidence: 100,
                    evidence: [`Server: ${server}`],
                    recommendation: 'Remove or obfuscate Server header',
                    references: ['https://owasp.org/Top10/A05_2021-Security_Misconfiguration/']
                });
            }

        } catch (e) {
            console.error(`[Headers] Failed scan: ${e}`);
        }

        return findings;
    }
}
