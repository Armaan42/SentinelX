import { BaseScanner } from './active-base.ts';
import { CrawledUrl, VulnerabilityFinding } from '../../core/types.ts';
import { CSRF_TOKENS } from '../../core/payloads.ts';

export class CsrfScanner extends BaseScanner {
    async scan(target: CrawledUrl): Promise<VulnerabilityFinding[]> {
        const findings: VulnerabilityFinding[] = [];

        // Check forms for anti-CSRF tokens
        for (const form of target.forms) {
            if (form.method.toUpperCase() === 'POST') {
                const hasToken = form.inputs.some(input =>
                    CSRF_TOKENS.some(token => input.name.toLowerCase().includes(token))
                );

                if (!hasToken) {
                    findings.push({
                        id: `CSRF-${Date.now()}`,
                        title: 'Form Missing CSRF Token',
                        owasp_category: 'A01:2021 - Broken Access Control',
                        severity: 'medium',
                        status: 'vulnerable',
                        detection_type: 'misconfiguration',
                        confidence: 80,
                        evidence: [`Form action: ${form.action}`, 'No CSRF token input found'],
                        recommendation: 'Add unique anti-CSRF tokens to all state-changing forms.',
                        references: ['https://owasp.org/Top10/A01_2021-Broken_Access_Control/'],
                        affected_url: target.url
                    });
                }
            }
        }
        return findings;
    }
}
