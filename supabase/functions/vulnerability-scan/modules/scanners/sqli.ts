import { BaseScanner } from './active-base.ts';
import { CrawledUrl, VulnerabilityFinding } from '../../core/types.ts';
import { SQL_PAYLOADS } from '../../core/payloads.ts';
import { Analyzer } from '../../core/analyzer.ts';

export class SqliScanner extends BaseScanner {
    async scan(target: CrawledUrl): Promise<VulnerabilityFinding[]> {
        const findings: VulnerabilityFinding[] = [];
        const visitedParams = new Set<string>();

        // Test URL Parameters
        if (target.params.length > 0) {
            for (const param of target.params) {
                // Limit payloads to 3 per param for speed in serverless
                for (const payload of SQL_PAYLOADS.slice(0, 3)) {
                    const url = new URL(target.url);
                    url.searchParams.set(param, payload);

                    try {
                        const { response, duration } = await this.client.get(url.toString());
                        const body = await response.text();
                        const analysis = Analyzer.detectSqlError(body);

                        if (analysis.detected) {
                            // Phase 2: Advanced Verification (Multi-Vector & Control Group)
                            console.log(`[SQLi] Potential hit on ${param}, initiating Triple Verification...`);

                            const verification = await this.verifyVulnerability(
                                target.url,
                                param,
                                payload,
                                (bodyStr) => Analyzer.detectSqlError(bodyStr).detected
                            );

                            if (verification.confirmed) {
                                findings.push({
                                    id: `SQLI-${Date.now()}`,
                                    title: 'SQL Injection Detected',
                                    owasp_category: 'A03:2021 - Injection',
                                    severity: 'critical',
                                    status: 'vulnerable',
                                    detection_type: 'sqli',
                                    confidence: verification.confidence,
                                    evidence: [
                                        `Payload: ${payload}`,
                                        `Error: ${analysis.snippet}`,
                                        ...verification.evidence
                                    ],
                                    recommendation: 'Use parameterized queries or prepared statements.',
                                    references: ['https://owasp.org/Top10/A03_2021-Injection/'],
                                    affected_url: target.url,
                                    param,
                                    payload
                                });
                                break; // Found confirmed vulnerability in this param, move to next
                            } else {
                                console.warn(`[SQLi] False positive discarded on ${param} (Failed Verification)`);
                            }
                        }
                    } catch (e) {
                        // ignore
                    }
                }
            }
        }

        return findings;
    }
}
