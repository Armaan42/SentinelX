import { ScanConfig } from './types.ts';

const RATE_LIMIT_DELAY = 500; // ms

export class HttpClient {
    private config: ScanConfig;
    private globalHeaders: Record<string, string> = {};

    constructor(config: ScanConfig) {
        this.config = config;
    }

    setHeaders(headers: Record<string, string>) {
        this.globalHeaders = { ...this.globalHeaders, ...headers };
    }

    private async sleep(ms: number) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async fetch(url: string, options: RequestInit = {}): Promise<{ response: Response; duration: number }> {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), this.config.timeout);

        // Apply rate limiting
        await this.sleep(RATE_LIMIT_DELAY);

        const startTime = Date.now();
        try {
            const response = await fetch(url, {
                ...options,
                signal: controller.signal,
                headers: {
                    'User-Agent': this.config.userAgent,
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                    ...this.globalHeaders,
                    ...options.headers,
                },
            });

            clearTimeout(timeoutId);
            return { response, duration: Date.now() - startTime };
        } catch (error) {
            clearTimeout(timeoutId);
            throw error;
        }
    }

    async get(url: string) {
        return this.fetch(url, { method: 'GET' });
    }

    async post(url: string, body: any, isJson = false) {
        const headers: Record<string, string> = {};
        if (isJson) {
            headers['Content-Type'] = 'application/json';
        } else {
            headers['Content-Type'] = 'application/x-www-form-urlencoded';
        }

        return this.fetch(url, {
            method: 'POST',
            headers,
            body: isJson ? JSON.stringify(body) : new URLSearchParams(body).toString(),
        });
    }
}
